<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login and Signup with OTP</title>

    <style>
        body {
            background-color: #bacaff;
            font-family: 'Ubuntu', sans-serif;
        }

        .main {
            background-color: #ffffff;
            width: 400px;
            margin: 7em auto;
            border-radius: 1.5em;
            box-shadow: 0px 11px 35px 2px rgba(0, 0, 0, 0.14);
            padding: 20px;
        }

        .sign {
            padding-top: 20px;
            color: #009dff;
            font-family: 'Ubuntu', sans-serif;
            font-weight: bold;
            font-size: 23px;
            text-align: center;
        }

        .input-field {
            width: 76%;
            color: rgb(38, 50, 56);
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
            background: rgba(136, 126, 126, 0.04);
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 20px;
            margin-left: 46px;
            text-align: center;
            font-family: 'Ubuntu', sans-serif;
        }

        .submit {
            cursor: pointer;
            border-radius: 5em;
            color: #fff;
            background: linear-gradient(to right, #0284d4, #009dff);
            border: 0;
            padding-left: 40px;
            padding-right: 40px;
            padding-bottom: 10px;
            padding-top: 10px;
            font-family: 'Ubuntu', sans-serif;
            margin-left: 35%;
            font-size: 13px;
            box-shadow: 0 0 20px 1px rgba(0, 0, 0, 0.04);
        }

        .otp-section {
            display: none;
        }

        .forgot {
            text-shadow: 0px 0px 3px rgba(80, 167, 249, 0.12);
            color: #3ab3fe;
            padding-top: 15px;
        }

        a {
            text-shadow: 0px 0px 3px rgba(117, 117, 117, 0.12);
            color: #009dff;
            text-decoration: none;
        }

        @media (max-width: 600px) {
            .main {
                border-radius: 0px;
            }
        }
    </style>
</head>

<body>
    <div class="main">
        <p class="sign">Sign in</p>

        <!-- Login Section -->
        <div id="login-section">
            <input class="input-field" type="text" id="username" placeholder="Enter your username" required>
            <input class="input-field" type="password" id="password" placeholder="Enter your password" required>
            <a class="submit" onclick="loginUser()">Continue</a>
            <p class="forgot" align="center"><a href="#" onclick="showSignupSection()">Don't have an account?</a></p>
        </div>

        <!-- Signup Section -->
        <div id="signup-section" style="display: none;">
            <input class="input-field" type="email" id="email" placeholder="Enter your email" required>
            <a class="submit" onclick="sendOtp()">Send OTP</a>
        </div>

        <!-- OTP Section -->
        <div id="otp-section" class="otp-section">
            <input class="input-field" type="text" id="otp" placeholder="Enter OTP" required>
            <a class="submit" onclick="verifyOtp()">Verify OTP</a>
        </div>

        <!-- Create Username/Password Section -->
        <div id="create-user-section" class="otp-section">
            <input class="input-field" type="text" id="new-username" placeholder="Enter your username" required>
            <input class="input-field" type="password" id="new-password" placeholder="Enter your password" required>
            <a class="submit" onclick="createUserAccount()">Create Account</a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

    <script type="module">
        // Import Firebase SDK correctly
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    
        // ðŸ”¥ Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCf3DEtBFcshBskWhUzRsWukynOnLVURpc",
            authDomain: "edurack-login.firebaseapp.com",
            projectId: "edurack-login",
            storageBucket: "edurack-login.firebasestorage.app",
            messagingSenderId: "60352018258",
            appId: "1:60352018258:web:d3fe771ec01a0217bb2c8b"
        };
    
        // ðŸ”¥ Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        // ðŸ”¹ Login Function
        async function loginUser() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
    
            if (username && password) {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);
    
                if (querySnapshot.empty) {
                    alert("Username not found.");
                } else {
                    querySnapshot.forEach((doc) => {
                        if (doc.data().password === password) {
                            alert("Login successful!");
                        } else {
                            alert("Incorrect password.");
                        }
                    });
                }
            } else {
                alert("Please enter both username and password.");
            }
        }
    
        // ðŸ”¹ Show Signup Section
        function showSignupSection() {
            document.getElementById("login-section").style.display = "none";
            document.getElementById("signup-section").style.display = "block";
        }
    
        // ðŸ”¹ Send OTP to Email
        async function sendOtp() {
            const email = document.getElementById("email").value;
    
            if (email) {
                const actionCodeSettings = {
                    url: 'https://your-app-url.com/finishSignUp?email=' + email,
                    handleCodeInApp: true
                };
    
                try {
                    await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                    window.localStorage.setItem('emailForSignUp', email);
                    alert("OTP sent to your email!");
                    document.getElementById("signup-section").style.display = "none";
                    document.getElementById("otp-section").style.display = "block";
                } catch (error) {
                    console.error("Error sending OTP:", error.message);
                    alert("Error sending OTP. Please try again.");
                }
            } else {
                alert("Please enter a valid email.");
            }
        }
    
        // ðŸ”¹ Verify OTP
        async function verifyOtp() {
            const email = window.localStorage.getItem('emailForSignUp');
    
            if (isSignInWithEmailLink(auth, window.location.href)) {
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    alert("OTP verified, and account created!");
                    document.getElementById("otp-section").style.display = "none";
                    document.getElementById("create-user-section").style.display = "block";
                } catch (error) {
                    console.error("Error verifying OTP:", error.message);
                    alert("OTP verification failed. Please try again.");
                }
            }
        }
    
        // ðŸ”¹ Create New User
        async function createUserAccount() {
            const username = document.getElementById("new-username").value;
            const password = document.getElementById("new-password").value;
            const email = window.localStorage.getItem('emailForSignUp');
    
            if (username && password) {
                try {
                    await addDoc(collection(db, "users"), {
                        username,
                        password,
                        email
                    });
    
                    alert("User account created successfully!");
                    window.location.href = 'login.html'; // Redirect to login page
                } catch (error) {
                    console.error("Error adding user: ", error);
                    alert("Error creating account.");
                }
            } else {
                alert("Please enter both username and password.");
            }
        }
    
        // Attach functions to window so they work in HTML
        window.loginUser = loginUser;
        window.showSignupSection = showSignupSection;
        window.sendOtp = sendOtp;
        window.verifyOtp = verifyOtp;
        window.createUserAccount = createUserAccount;
    </script>
    
</body>
</html>
